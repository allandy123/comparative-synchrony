# Description
These data and scripts were used to produce results and figures for the 
manuscript titled "Factors driving the spatial synchrony of forest insect pest 
outbreaks in North America."

Spatial synchrony in outbreaks was assessed based on annual aerial surveys of defoliation or tree mortality from bark beetles, conducted from 1997-2020 in the US (except 1997-2019 for the spongy moth and 1999-2020 for Douglas-fir tussock moth) and 1999-2020 in Canada. The defoliation and tree mortality data were obtained from the US Forest Service Forest Health Protection National Insect and Disease Detection Survey (https://www.fs.usda.gov/foresthealth/applied-sciences/mapping-reporting/detection-surveys.shtml) and the National Forest Pest Strategy Information System (Canada). The defoliation and tree mortality data were obtained from the National Insect and Disease Detection Survey (US) and the National Forestry Database (Canada). Data from 1997 and 1998 from Canada were excluded due to inconsistencies in surveying during a transition from federally administered surveys to provincial surveys. For the data in both the U.S. and Canada, all damage maps were initially recorded as polygons but these data were then converted to raster layers representing the presence or absence of defoliation or tree mortality within 250 Ã— 250 m (US) or 500 Ã— 500 m cells (Canada), which were then used aggregated to a common scale of 25 Ã— 25 km cells with the total number of cells damaged computed for each 25 Ã— 25 km cell. The number of cells damaged per 25 Ã— 25 km cell was considered a proxy of pest density. In Manitoba and the Northwest Territories, areas within National Parks are not surveyed. Therefore, cells overlapping with National Park land in these two provinces were excluded. To avoid singular correlation matrices when computing synchrony, we excluded all cells for a given species with < 3 years of damage. First-order differencing of the time series of damage was then performed, yielding annual changes in damage levels, to remove any long-term trends because such trends shared between time series could inflate estimates of synchrony.

Spatial synchrony in weather was assessed using historical estimates of monthly precipitation and mean monthly minimum and maximum temperatures in each of the cells. Weather data for both the USA and Canada were obtained from a Natural Resources Canada dataset generated by the ANUSPLIN climate mapping model (McKenney et al. 2011). These data were collected in raster format at a resolution of 2 Ã— 2 km and then averaged across the same 25 Ã— 25 km cells in which pest species damage was quantified. Separate annual time series were prepared for each of 36 weather variables comprising the means (temperatures) or totals (precipitation) of the three weather variables for each month. Principal components analysis was used to collapse this large number of weather variables into a smaller number of uncorrelated variables. We used the time series of the (first-order differenced) scores from the three dominant principal components of weather in our analyses of the synchrony of weather. Three explanatory matrices were used to represent the synchrony in weather. The elements in each of these matrices were the pairwise synchronies (Spearman rank correlations) of the scores of the (differenced) first, second, and third principal components of weather, respectively.

The spatial structure of the sample locations was represented in proximity (distance) matrices. Pairwise proximity values were calculated as the inverse power function ð‘ð‘‘ð‘–,ð‘—âˆ’ð‘, where ð‘‘ð‘–,ð‘— is the Euclidean distance between cells i and j, c is a scaling constant and b determines the rate of decay with increasing distance. The values of c were obtained as regression coefficients from the MRM models with the value of b arbitrarily set at 1.

We compared synchrony of pest damage at lag distances of 25 km (the shortest distance between any two sample locations), 100 km, 200 km, and 300 km. Synchrony at these lag distances was estimated using the â€œSncfâ€ function from the R package â€˜ncfâ€™ (BjÃ¸rnstad 2022). Synchrony values for lag distances beyond a threshold of one-half of the maximum distance between sample locations were omitted.

<b>Note</b>: Throughout this repository, we refer to defoliation or tree mortality as "defoliation" for shorthand.

## References

BjÃ¸rnstad, O. N. 2022. ncf: Spatial Covariance Functions.

McKenney, D. W., Hutchinson, M. F., Papadopol, P., Lawrence, K., Pedlar, J., Campbell, K., Milewska, E., Hopkinson, R. F., Price, D. and Owen, T. 2011. Customized Spatial Climate Models for North America. - Bulletin of the American Meteorological Society 92: 1611â€“1622.

# Folder Organization
- All R and slurm scripts are stored in "scripts"
- Raw and derived data are stored in the "data" folder. Subfolders are named for
the types of data they contain, and each folder contains a metadata readme file.
- Results of the primary analyses are stored in the "results" folder. Subfolders 
break down results into the stages of our analyses (pca, sncf, and mrm). 
- Figures created in these scripts are exported to the "figures" folder. Subfolders
here are similar to the results folder.

Throughout, the folder will indicate file contents, while the file names 
indicate the data source (USA or Canada), an underscore, followed by their 
species code as found in "./data/species_codes.csv". As an example, "ca_dfb.csv"
under folder ./data/defoliation/synchrony_matrices/ would contain the synchrony
matrices for Douglas-fir beetle in Canada. Data folders also contain a text 
metadata readme file explaining their contents in more detail.

Also note that data from Canada and USA were provided in different projections.
More information can be found in the readme files within the data subfolder.

# Instructions
Scripts all in the folder "scripts", and are numbered roughly in the order they 
should be run. Each script contains a header explaining what it does, its 
inputs, and its outputs.

Optional: "install_packages.R" - Exactly what is says. In particular, "mms" is
installed directly from Github rather than an R repository.

Optional: Scripts 0 to 4 download and set up the data for the primary analyses.
This includes the Principle Components Analysis of weather data, which is used 
as input for later analyses. These have already been completed with the data you
downloaded, so you only need to run these scripts if you are interested in these
steps. In that case, start with script 0 to download the raw data you will need.

Scripts 5 to 10 perform the main sncf and mrm analyses and compile the results. 
These are likely of main interest to most readers. 

Note that script 9 was run on the UVA computer 
cluster via the ".slurm" script. This analysis is unlikely to run properly on 
your own computer due to memory constraints.

"helper_functions.R" contains functions used in script 9. It does not need to be 
run on its own.
